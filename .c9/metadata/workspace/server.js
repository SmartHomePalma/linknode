{"filter":false,"title":"server.js","tooltip":"/server.js","undoManager":{"mark":100,"position":100,"stack":[[{"group":"doc","deltas":[{"action":"removeLines","range":{"start":{"row":0,"column":0},"end":{"row":462,"column":0}},"nl":"\r\n","lines":["var express = require('express');","var crypto = require('crypto');","var moment = require('moment');","var bodyParser = require('body-parser');","var cookieParser = require('cookie-parser');","var session = require('express-session');","var net = require('net');","var pass = require('pwd');","var app = express();","","var httpport = 8080;","var port = 30059;","var guestId = 0;","","var data_obj = require('./redis.js');","var socket_obj = require('./socket.js');","var wechat_obj = require('./wechat.js');","","var Users = {","\t\"USERNAME\"  : \"\",","\t\"EMAIL\"  : \"\",","\t\"SALT\"\t: \"\",","\t\"HASH\"\t: \"\",","\t\"DEVICEID\"  : \"\",","\t\"TOKIN\"  : \"\"","};","","var DeviceState = {","\t\"DeviceId\"  : \"00000000\",","\t\"IsSuccess\" : \"Success\",","\t\"NSlots\"    : \"5\",","\t\"State\"     : \"00000\",","\t\"ServerTime\": \"2014-5-19 14:47:56\"","};","","var server = net.createServer(function(socket) {","\t// Increment","\tguestId++;","\tsocket.nickname = \"Client_\" + guestId;","\tvar clientName = socket.nickname;","\tsocket_obj.pushsocket(socket);","\t// Log it to the server output","\tconsole.log(clientName + ' connected.');","\t// Welcome user to the socket","\tsocket.write(\"Hi \"+ clientName +\" Welcome!\\n\");","\t// Broadcast to others excluding this socket","\t//broadcast(clientName, clientName + ' joined this chat.\\n');","\t// When client sends data","\tsocket.on('data', function(data) {","\t\t//var message = clientName + '> ' + data.toString();","\t\t//broadcast(clientName, message);","\t\t//process.stdout.write(message);","\t});","\t// When client leaves","\tsocket.on('end', function() {","\t\tvar message = clientName + ' disconnected\\n';","\t\tconsole.log(message);","\t\tsocket_obj.removeSocket(socket);","\t\t//broadcast(clientName, message);","\t});","\t// When socket gets errors","\tsocket.on('error', function(error) {","\t\tconsole.log('Socket got problems: ', error.message);","\t});","});","","// Listening for any problems with the server","server.on('error', function(error) {","\tconsole.log(\"So we got problems!\", error.message);","});","","// Listen for a port to telnet to","// then in the terminal just run 'telnet localhost [port]'","server.listen(port, function() {","\tconsole.log(\"TCP  listening on port :\" + port);","});","","app.use(express.static(__dirname + '/public'));","app.use(bodyParser());","app.use(cookieParser('shhhh, very secret'));","app.use(session());","","app.use(function(req, res, next){","    var err = req.session.error;","    var msg = req.session.success;","    delete req.session.error;","    delete req.session.success;","    res.locals.message = '';","    if (err) {","        res.locals.message = '<p class=\"msg error\">' + err + '</p>';","    }","    if (msg) {","        res.locals.message = '<p class=\"msg success\">' + msg + '</p>';","    }","    next();","});","","function authenticate(name, pass, fn) {","\tvar userinfo = Users;","\tif (!module.parent) {","        //console.log('authenticating %s:%s', name, pass);","\t}","\tdata_obj.UserQuery(name, function(temp) {","\t\tif (temp === null) {","\t\t\tconsole.log(\"cannot find user\");","\t\t\treturn fn(new Error('cannot find user'));","\t\t} else {","            userinfo = JSON.parse(temp);","            //console.log(\"Query Result:\" + userinfo.USERNAME);","            //console.log(\"userinfo.SALT:\" + userinfo.SALT);","            var password = require('pwd');","            password.hash(pass, userinfo.SALT, function(err, hash) {","                if (err) {","                    return fn(err);","                }","                if (userinfo.HASH == hash) {","                    console.log(\"User authenticate success:\" + name);","                    return fn(null, temp); // yay","                }","                return fn(new Error('invalid password'));","            });","        }","\t});","}","","function restrict(req, res, next) {","    if (req.session.user) {","        //console.log(\"User: \" + req.session.user);","        next();","    } else {","        req.session.error = 'Access denied!';","        res.redirect('/login');","    }","}","","app.use(function(err, req, res, next) {","    console.error(err.stack);","    res.send(500, 'Something broke!');","});","","app.get('/panel', restrict, function(req, res) {","    res.sendfile('./public/admin.html');","});","","app.get('/panel/accessibility', restrict, function(req, res) {","    res.sendfile('./public/accessibility.html');","});","","app.get('/tokin/:refresh?', restrict, function(req, res) {","    var userinfo = Users;","    if (req.params.refresh !== undefined) {","        data_obj.UserQuery(req.session.user , function(temp) {","            if(temp === undefined || temp === null || temp ===\"\") {","                res.send(\"User not found!\");","            }","            else","            {","                userinfo = JSON.parse(temp);","                crypto.randomBytes(16, function(ex, buf) {  ","                    userinfo.TOKIN = buf.toString('hex').toUpperCase();","                    data_obj.UserUpdate(req.session.user, JSON.stringify(userinfo), function(result) {","                        res.send(result);","                    });","                }); ","            }","        });","    } else {","        data_obj.UserQuery(req.session.user , function(UserInfo) {","            if(UserInfo === undefined || UserInfo === null || UserInfo ===\"\") {","                res.send(\"User not found!\");","            }","            else","            {","                res.send(UserInfo);","            }","        });","    }","});","","app.get('/password/:new', restrict, function(req, res) {","    var userinfo = Users;","    data_obj.UserQuery(req.session.user , function(temp) {","        if(temp === undefined || temp === null || temp ===\"\") {","            res.send(\"User not found!\");","        } else {","            userinfo = JSON.parse(temp);","            pass.hash(req.params.new, function(err, salt, hash) {","                userinfo.SALT = salt;","                userinfo.HASH = hash;","                crypto.randomBytes(16, function(ex, buf) {  ","                    userinfo.TOKIN = buf.toString('hex').toUpperCase();","                    data_obj.UserUpdate(userinfo.USERNAME, JSON.stringify(userinfo), function(temp) {","                        authenticate(userinfo.USERNAME, req.params.new, function(err, userinfo) {","                            if(err === null) {","                                var user = JSON.parse(userinfo);","                                if (user.USERNAME) {","                                    req.session.regenerate(function(){","                                    req.session.user = user.USERNAME;","                                    req.session.success = 'Authenticated as ' + user.USERNAME","                                      + ' click to <a href=\"/logout\">logout</a>. '","                                      + ' You may now access <a href=\"/panel\">/panel</a>.';","                                    res.send(user);","                                  });","                                }","                            }","                        });","                    });","                }); ","            });","        }","    });","});","","app.get('/panel/device', restrict, function(req, res) {","    res.sendfile('./public/device.html');","});","","app.get('/panel/user', restrict, function(req, res) {","    res.sendfile('./public/user.html');","});","","app.get('/login', function(req, res) {","    res.sendfile('./public/login.html');","});","","app.get('/register', function(req, res) {","    res.sendfile('./public/register.html');","});","","app.get('/logout', function(req, res) {","    // destroy the user's session to log them out","    // will be re-created next request","    req.session.destroy(function() {","        res.redirect('/panel');","    });","});","","app.post('/register', function(req, res) {","    var newUsers = Users;","\tif(req.body.uname === \"\") {","\t\tres.redirect('/error_uname');","\t}","\tif(req.body.email === \"\") {","\t\tres.redirect('/error_email');","\t}","\tif(req.body.password === \"\") {","\t\tres.redirect('/error_password');","\t}","\tnewUsers.USERNAME = req.body.uname;","\tnewUsers.EMAIL = req.body.email;","\t","\tpass.hash(req.body.password, function(err, salt, hash) {","\t\tnewUsers.SALT = salt;","\t\tnewUsers.HASH = hash;","\t\tcrypto.randomBytes(16, function(ex, buf) {  ","\t\t\tnewUsers.TOKIN = buf.toString('hex').toUpperCase();","\t\t\tdata_obj.UserRegister(newUsers.USERNAME, JSON.stringify(newUsers), function(temp) {","\t\t\t\t//res.send(temp);","\t\t\t\tauthenticate(newUsers.USERNAME, req.body.password, function(err, userinfo) {","                    if(err === null) {","                        var user = JSON.parse(userinfo);","                        if (user.USERNAME) {","                            req.session.regenerate(function(){","                            req.session.user = user.USERNAME;","                            req.session.success = 'Authenticated as ' + user.USERNAME","                              + ' click to <a href=\"/logout\">logout</a>. '","                              + ' You may now access <a href=\"/panel\">/panel</a>.';","                            res.redirect('/panel');","                          });","                        } else {","                            req.session.error = 'Authentication failed, please check your '","                            + ' username and password.';","                            res.redirect('back');","                        }","                    } else {","                        req.session.error = 'Authentication failed, please check your '","                            + ' username and password.';","                        res.redirect('/login');","                    }","                });","\t\t\t});","\t\t}); ","\t}); ","});","","app.post('/login', function(req, res) {","    //console.log(req.body.uname);","    //console.log(req.body.password);","    if(req.body.uname === null || req.body.password === null)","    {","        console.log(\"Error ,username or password empty!\");","        req.session.error = 'Authentication failed, please check your '","            + ' username and password.';","        res.redirect('/login');","        ","    } else {","        authenticate(req.body.uname, req.body.password, function(err, userinfo) {","        if(err === null) {","            var user = JSON.parse(userinfo);","            if (user.USERNAME) {","              // Regenerate session when signing in","              // to prevent fixation","                req.session.regenerate(function(){","                // Store the user's primary key","                // in the session store to be retrieved,","                // or in this case the entire user object","                req.session.user = user.USERNAME;","                req.session.success = 'Authenticated as ' + user.USERNAME","                  + ' click to <a href=\"/logout\">logout</a>. '","                  + ' You may now access <a href=\"/panel\">/panel</a>.';","                //console.log(\"Login success:\" + user.USERNAME);","                res.redirect('/panel');","              });","            } else {","              req.session.error = 'Authentication failed, please check your '","                + ' username and password.';","              res.redirect('back');","            }","        } else {","            //console.log(\"ErrMsg:\" + err);","            //console.log(\"UserInfo:\" + userinfo);","            req.session.error = 'Authentication failed, please check your '","                + ' username and password.';","            res.redirect('/login');","        }","        });","    }","});","","//app.get(\"/user/delete/:user\" , function(req, res) {","//\tdata_obj.UserRegister(req.params.user, \"\", function(temp) {","//\t\tres.send(temp);","//\t});","//});","","app.get(\"/user/delete\" ,restrict , function(req, res) {","\tdata_obj.UserRegister(req.session.user, \"\", function(temp) {","\t\t//res.send(temp);","\t\treq.session.destroy(function() {","            res.redirect('/panel');","        });","\t});","});","","app.get(\"/user\" ,restrict , function(req, res) {","\tdata_obj.UserQuery(req.session.user , function(UserInfo) {","\t\tif(UserInfo === undefined || UserInfo === null ||UserInfo ===\"\") {","\t\t\tres.send(\"User not found!\");","\t\t}","\t\telse","\t\t{","\t\t\tres.send(UserInfo);","\t\t}","\t});","});","","app.get('/wechat',function(req, res) {","    wechat_obj.validateToken(req, res);","});","","app.post('/wechat',function(req, res) {","\t//var xmldata = wechat_obj.handler(req,res);","\twechat_obj.handler(req, res);","});","","app.get(\"/bind/:id\", restrict, function(req, res) {","\tvar userinfo = Users;","\tif (req.params.id !== undefined && req.session.user !== undefined) {","        data_obj.UserQuery(req.session.user, function(temp) {","            if (temp === null) {","                console.log(\"cannot find user\");","                res.send(\"cannot find user\");","            } else {","                userinfo = JSON.parse(temp);","                userinfo.DEVICEID = req.params.id;","                //console.log(\"Query Result:\" + userinfo.USERNAME);","                //console.log(\"\\nUserinfo.DEVICEID:\" + userinfo.DEVICEID);","                ","                data_obj.UserUpdate(userinfo.USERNAME, JSON.stringify(userinfo), function(temp) {","                    res.send(temp);","                });","            }","        });","\t}","\telse {","\t\tres.send(\"UserName / DeviceId error or not login!\");","\t}","});","","app.get(\"/device/:id/:slot?/:operation?\" , function(req, res) {","\tvar json_out = DeviceState;","\tjson_out.DeviceId = req.params.id;","\tjson_out.ServerTime = moment().format('YYYY-MM-DD, HH:mm:ss');","\tif (req.params.operation !== undefined) {","\t\tdata_obj.setRedis(req.params.id, null, req.params.slot, req.params.operation, function(temp) {","\t\t\tjson_out.State = temp;","\t\t\tsocket_obj.broadcast('SYSTEM',JSON.stringify(json_out) + '\\n');","\t\t\tres.send(JSON.stringify(json_out));","\t\t});","\t}","\telse {","\t\tdata_obj.getRedis(req.params.id , function(temp) {\t\t\t","\t\t\tjson_out.State = temp;\t\t\t","\t\t\tsocket_obj.broadcast('SYSTEM',JSON.stringify(json_out) + '\\n');","\t\t\tres.send(JSON.stringify(json_out));","\t\t});","\t}","});","","","app.get(\"/api/device/:slot?/:operation?\", restrict, function(req, res) {","\tvar json_out = DeviceState;","    var userinfo = Users;","\tjson_out.ServerTime = moment().format('YYYY-MM-DD, HH:mm:ss');","\tif (req.params.operation !== undefined) {","        data_obj.UserQuery(req.session.user, function(temp) {","            if (temp === null) {","                console.log(\"cannot find user\");","            } else {","                userinfo = JSON.parse(temp);","                //console.log(\"Query Result:\" + userinfo.USERNAME);","                //console.log(\"userinfo.DEVICEID:\" + userinfo.DEVICEID);","                if(userinfo.DEVICEID !== null && userinfo.DEVICEID !== \"\") {","                    json_out.DeviceId = userinfo.DEVICEID;","                    data_obj.setRedis(userinfo.DEVICEID, null, req.params.slot, req.params.operation, function(temp) {","                        json_out.State = temp;","                        socket_obj.broadcast('SYSTEM',JSON.stringify(json_out) + '\\n');","                        res.send(JSON.stringify(json_out));","                    });                    ","                } else {","                    res.send(\"Device id null.\");","                }","            }","        });","\t}","\telse {","        data_obj.UserQuery(req.session.user, function(temp) {","            if (temp === null) {","                console.log(\"cannot find user\");","            } else {","                userinfo = JSON.parse(temp);","                console.log(userinfo.DEVICEID);","                if(userinfo.DEVICEID !== null && userinfo.DEVICEID !== \"\") {","                    json_out.DeviceId = userinfo.DEVICEID;","                    data_obj.getRedis(userinfo.DEVICEID , function(temp) {\t\t\t","                        json_out.State = temp;","                        socket_obj.broadcast('SYSTEM',JSON.stringify(json_out) + '\\n');","                        res.send(JSON.stringify(json_out));","                    });                   ","                } else {","                    res.send(\"Device id null.\");","                }","            }","        });","        ","\t}","});","","var server = app.listen(httpport, function() {","    console.log('HTTP listening on port :%d', server.address().port);","    console.log('Dir :%s', __dirname);","});"]},{"action":"insertText","range":{"start":{"row":0,"column":0},"end":{"row":0,"column":33}},"text":"var express = require('express');"},{"action":"insertText","range":{"start":{"row":0,"column":33},"end":{"row":1,"column":0}},"text":"\r\n"},{"action":"insertLines","range":{"start":{"row":1,"column":0},"end":{"row":468,"column":0}},"lines":["var crypto = require('crypto');","var moment = require('moment');","var bodyParser = require('body-parser');","var cookieParser = require('cookie-parser');","var session = require('express-session');","var net = require('net');","var pass = require('pwd');","var app = express();","","var httpport = 8080;","var port = 30059;","var guestId = 0;","","var data_obj = require('./redis.js');","var socket_obj = require('./socket.js');","var wechat_obj = require('./wechat.js');","","var UserDelete = {","    \"IsSuccess\" : \"false\"","};","","var Users = {","\t\"USERNAME\"  : \"\",","\t\"EMAIL\"  : \"\",","\t\"SALT\"\t: \"\",","\t\"HASH\"\t: \"\",","\t\"DEVICEID\"  : \"\",","\t\"TOKIN\"  : \"\"","};","","var DeviceState = {","\t\"DeviceId\"  : \"00000000\",","\t\"IsSuccess\" : \"Success\",","\t\"NSlots\"    : \"5\",","\t\"State\"     : \"00000\",","\t\"ServerTime\": \"2014-5-19 14:47:56\"","};","","var server = net.createServer(function(socket) {","\t// Increment","\tguestId++;","\tsocket.nickname = \"Client_\" + guestId;","\tvar clientName = socket.nickname;","\tsocket_obj.pushsocket(socket);","\t// Log it to the server output","\tconsole.log(clientName + ' connected.');","\t// Welcome user to the socket","\tsocket.write(\"Hi \"+ clientName +\" Welcome!\\n\");","\t// Broadcast to others excluding this socket","\t//broadcast(clientName, clientName + ' joined this chat.\\n');","\t// When client sends data","\tsocket.on('data', function(data) {","\t\t//var message = clientName + '> ' + data.toString();","\t\t//broadcast(clientName, message);","\t\t//process.stdout.write(message);","\t});","\t// When client leaves","\tsocket.on('end', function() {","\t\tvar message = clientName + ' disconnected\\n';","\t\tconsole.log(message);","\t\tsocket_obj.removeSocket(socket);","\t\t//broadcast(clientName, message);","\t});","\t// When socket gets errors","\tsocket.on('error', function(error) {","\t\tconsole.log('Socket got problems: ', error.message);","\t});","});","","// Listening for any problems with the server","server.on('error', function(error) {","\tconsole.log(\"So we got problems!\", error.message);","});","","// Listen for a port to telnet to","// then in the terminal just run 'telnet localhost [port]'","server.listen(port, function() {","\tconsole.log(\"TCP  listening on port :\" + port);","});","","app.use(express.static(__dirname + '/public'));","app.use(bodyParser());","app.use(cookieParser('shhhh, very secret'));","app.use(session());","","app.use(function(req, res, next){","    var err = req.session.error;","    var msg = req.session.success;","    delete req.session.error;","    delete req.session.success;","    res.locals.message = '';","    if (err) {","        res.locals.message = '<p class=\"msg error\">' + err + '</p>';","    }","    if (msg) {","        res.locals.message = '<p class=\"msg success\">' + msg + '</p>';","    }","    next();","});","","function authenticate(name, pass, fn) {","\tvar userinfo = Users;","\tif (!module.parent) {","        //console.log('authenticating %s:%s', name, pass);","\t}","\tdata_obj.UserQuery(name, function(temp) {","\t\tif (temp === null) {","\t\t\tconsole.log(\"cannot find user\");","\t\t\treturn fn(new Error('cannot find user'));","\t\t} else {","            userinfo = JSON.parse(temp);","            //console.log(\"Query Result:\" + userinfo.USERNAME);","            //console.log(\"userinfo.SALT:\" + userinfo.SALT);","            var password = require('pwd');","            password.hash(pass, userinfo.SALT, function(err, hash) {","                if (err) {","                    return fn(err);","                }","                if (userinfo.HASH == hash) {","                    console.log(\"User authenticate success:\" + name);","                    return fn(null, temp); // yay","                }","                return fn(new Error('invalid password'));","            });","        }","\t});","}","","function restrict(req, res, next) {","    if (req.session.user) {","        //console.log(\"User: \" + req.session.user);","        next();","    } else {","        req.session.error = 'Access denied!';","        res.redirect('/login');","    }","}","","app.use(function(err, req, res, next) {","    console.error(err.stack);","    res.send(500, 'Something broke!');","});","","app.get('/panel', restrict, function(req, res) {","    res.sendfile('./public/admin.html');","});","","app.get('/panel/accessibility', restrict, function(req, res) {","    res.sendfile('./public/accessibility.html');","});","","app.get('/tokin/:refresh?', restrict, function(req, res) {","    var userinfo = Users;","    if (req.params.refresh !== undefined) {","        data_obj.UserQuery(req.session.user , function(temp) {","            if(temp === undefined || temp === null || temp ===\"\") {","                res.send(\"User not found!\");","            }","            else","            {","                userinfo = JSON.parse(temp);","                crypto.randomBytes(16, function(ex, buf) {  ","                    userinfo.TOKIN = buf.toString('hex').toUpperCase();","                    data_obj.UserUpdate(req.session.user, JSON.stringify(userinfo), function(result) {","                        res.send(result);","                    });","                }); ","            }","        });","    } else {","        data_obj.UserQuery(req.session.user , function(UserInfo) {","            if(UserInfo === undefined || UserInfo === null || UserInfo ===\"\") {","                res.send(\"User not found!\");","            }","            else","            {","                res.send(UserInfo);","            }","        });","    }","});","","app.get('/password/:new', restrict, function(req, res) {","    var userinfo = Users;","    data_obj.UserQuery(req.session.user , function(temp) {","        if(temp === undefined || temp === null || temp ===\"\") {","            res.send(\"User not found!\");","        } else {","            userinfo = JSON.parse(temp);","            pass.hash(req.params.new, function(err, salt, hash) {","                userinfo.SALT = salt;","                userinfo.HASH = hash;","                crypto.randomBytes(16, function(ex, buf) {  ","                    userinfo.TOKIN = buf.toString('hex').toUpperCase();","                    data_obj.UserUpdate(userinfo.USERNAME, JSON.stringify(userinfo), function(temp) {","                        authenticate(userinfo.USERNAME, req.params.new, function(err, userinfo) {","                            if(err === null) {","                                var user = JSON.parse(userinfo);","                                if (user.USERNAME) {","                                    req.session.regenerate(function(){","                                    req.session.user = user.USERNAME;","                                    req.session.success = 'Authenticated as ' + user.USERNAME","                                      + ' click to <a href=\"/logout\">logout</a>. '","                                      + ' You may now access <a href=\"/panel\">/panel</a>.';","                                    res.send(user);","                                  });","                                }","                            }","                        });","                    });","                }); ","            });","        }","    });","});","","app.get('/panel/device', restrict, function(req, res) {","    res.sendfile('./public/device.html');","});","","app.get('/panel/user', restrict, function(req, res) {","    res.sendfile('./public/user.html');","});","","app.get('/login', function(req, res) {","    res.sendfile('./public/login.html');","});","","app.get('/register', function(req, res) {","    res.sendfile('./public/register.html');","});","","app.get('/logout', function(req, res) {","    // destroy the user's session to log them out","    // will be re-created next request","    req.session.destroy(function() {","        res.redirect('/panel');","    });","});","","app.post('/register', function(req, res) {","    var newUsers = Users;","\tif(req.body.uname === \"\") {","\t\tres.redirect('/error_uname');","\t}","\tif(req.body.email === \"\") {","\t\tres.redirect('/error_email');","\t}","\tif(req.body.password === \"\") {","\t\tres.redirect('/error_password');","\t}","\tnewUsers.USERNAME = req.body.uname;","\tnewUsers.EMAIL = req.body.email;","\t","\tpass.hash(req.body.password, function(err, salt, hash) {","\t\tnewUsers.SALT = salt;","\t\tnewUsers.HASH = hash;","\t\tcrypto.randomBytes(16, function(ex, buf) {  ","\t\t\tnewUsers.TOKIN = buf.toString('hex').toUpperCase();","\t\t\tdata_obj.UserRegister(newUsers.USERNAME, JSON.stringify(newUsers), function(temp) {","\t\t\t\t//res.send(temp);","\t\t\t\tauthenticate(newUsers.USERNAME, req.body.password, function(err, userinfo) {","                    if(err === null) {","                        var user = JSON.parse(userinfo);","                        if (user.USERNAME) {","                            req.session.regenerate(function(){","                            req.session.user = user.USERNAME;","                            req.session.success = 'Authenticated as ' + user.USERNAME","                              + ' click to <a href=\"/logout\">logout</a>. '","                              + ' You may now access <a href=\"/panel\">/panel</a>.';","                            res.redirect('/panel');","                          });","                        } else {","                            req.session.error = 'Authentication failed, please check your '","                            + ' username and password.';","                            res.redirect('back');","                        }","                    } else {","                        req.session.error = 'Authentication failed, please check your '","                            + ' username and password.';","                        res.redirect('/login');","                    }","                });","\t\t\t});","\t\t}); ","\t}); ","});","","app.post('/login', function(req, res) {","    //console.log(req.body.uname);","    //console.log(req.body.password);","    if(req.body.uname === null || req.body.password === null)","    {","        console.log(\"Error ,username or password empty!\");","        req.session.error = 'Authentication failed, please check your '","            + ' username and password.';","        res.redirect('/login');","        ","    } else {","        authenticate(req.body.uname, req.body.password, function(err, userinfo) {","        if(err === null) {","            var user = JSON.parse(userinfo);","            if (user.USERNAME) {","              // Regenerate session when signing in","              // to prevent fixation","                req.session.regenerate(function(){","                // Store the user's primary key","                // in the session store to be retrieved,","                // or in this case the entire user object","                req.session.user = user.USERNAME;","                req.session.success = 'Authenticated as ' + user.USERNAME","                  + ' click to <a href=\"/logout\">logout</a>. '","                  + ' You may now access <a href=\"/panel\">/panel</a>.';","                //console.log(\"Login success:\" + user.USERNAME);","                res.redirect('/panel');","              });","            } else {","              req.session.error = 'Authentication failed, please check your '","                + ' username and password.';","              res.redirect('back');","            }","        } else {","            //console.log(\"ErrMsg:\" + err);","            //console.log(\"UserInfo:\" + userinfo);","            req.session.error = 'Authentication failed, please check your '","                + ' username and password.';","            res.redirect('/login');","        }","        });","    }","});","","//app.get(\"/user/delete/:user\" , function(req, res) {","//\tdata_obj.UserRegister(req.params.user, \"\", function(temp) {","//\t\tres.send(temp);","//\t});","//});","","app.get(\"/user/delete\" ,restrict , function(req, res) {","    var result = UserDelete;","\tdata_obj.UserRegister(req.session.user, \"\", function(temp) {","\t\t//res.send(temp);","\t\treq.session.destroy(function() {","            result.IsSuccess = \"true\";","            res.send(JSON.stringify(result));","        });","\t});","});","","app.get(\"/user\" ,restrict , function(req, res) {","\tdata_obj.UserQuery(req.session.user , function(UserInfo) {","\t\tif(UserInfo === undefined || UserInfo === null ||UserInfo ===\"\") {","\t\t\tres.send(\"User not found!\");","\t\t}","\t\telse","\t\t{","\t\t\tres.send(UserInfo);","\t\t}","\t});","});","","app.get('/wechat',function(req, res) {","    wechat_obj.validateToken(req, res);","});","","app.post('/wechat',function(req, res) {","\t//var xmldata = wechat_obj.handler(req,res);","\twechat_obj.handler(req, res);","});","","app.get(\"/bind/:id\", restrict, function(req, res) {","\tvar userinfo = Users;","\tif (req.params.id !== undefined && req.session.user !== undefined) {","        data_obj.UserQuery(req.session.user, function(temp) {","            if (temp === null) {","                console.log(\"cannot find user\");","                res.send(\"cannot find user\");","            } else {","                userinfo = JSON.parse(temp);","                userinfo.DEVICEID = req.params.id;","                //console.log(\"Query Result:\" + userinfo.USERNAME);","                //console.log(\"\\nUserinfo.DEVICEID:\" + userinfo.DEVICEID);","                ","                data_obj.UserUpdate(userinfo.USERNAME, JSON.stringify(userinfo), function(temp) {","                    res.send(temp);","                });","            }","        });","\t}","\telse {","\t\tres.send(\"UserName / DeviceId error or not login!\");","\t}","});","","app.get(\"/device/:id/:slot?/:operation?\" , function(req, res) {","\tvar json_out = DeviceState;","\tjson_out.DeviceId = req.params.id;","\tjson_out.ServerTime = moment().format('YYYY-MM-DD, HH:mm:ss');","\tif (req.params.operation !== undefined) {","\t\tdata_obj.setRedis(req.params.id, null, req.params.slot, req.params.operation, function(temp) {","\t\t\tjson_out.State = temp;","\t\t\tsocket_obj.broadcast('SYSTEM',JSON.stringify(json_out) + '\\n');","\t\t\tres.send(JSON.stringify(json_out));","\t\t});","\t}","\telse {","\t\tdata_obj.getRedis(req.params.id , function(temp) {\t\t\t","\t\t\tjson_out.State = temp;\t\t\t","\t\t\tsocket_obj.broadcast('SYSTEM',JSON.stringify(json_out) + '\\n');","\t\t\tres.send(JSON.stringify(json_out));","\t\t});","\t}","});","","","app.get(\"/api/device/:slot?/:operation?\", restrict, function(req, res) {","\tvar json_out = DeviceState;","    var userinfo = Users;","\tjson_out.ServerTime = moment().format('YYYY-MM-DD, HH:mm:ss');","\tif (req.params.operation !== undefined) {","        data_obj.UserQuery(req.session.user, function(temp) {","            if (temp === null) {","                console.log(\"cannot find user\");","            } else {","                userinfo = JSON.parse(temp);","                //console.log(\"Query Result:\" + userinfo.USERNAME);","                //console.log(\"userinfo.DEVICEID:\" + userinfo.DEVICEID);","                if(userinfo.DEVICEID !== null && userinfo.DEVICEID !== \"\") {","                    json_out.DeviceId = userinfo.DEVICEID;","                    data_obj.setRedis(userinfo.DEVICEID, null, req.params.slot, req.params.operation, function(temp) {","                        json_out.State = temp;","                        socket_obj.broadcast('SYSTEM',JSON.stringify(json_out) + '\\n');","                        res.send(JSON.stringify(json_out));","                    });                    ","                } else {","                    res.send(\"Device id null.\");","                }","            }","        });","\t}","\telse {","        data_obj.UserQuery(req.session.user, function(temp) {","            if (temp === null) {","                console.log(\"cannot find user\");","            } else {","                userinfo = JSON.parse(temp);","                console.log(userinfo.DEVICEID);","                if(userinfo.DEVICEID !== null && userinfo.DEVICEID !== \"\") {","                    json_out.DeviceId = userinfo.DEVICEID;","                    data_obj.getRedis(userinfo.DEVICEID , function(temp) {\t\t\t","                        json_out.State = temp;","                        socket_obj.broadcast('SYSTEM',JSON.stringify(json_out) + '\\n');","                        res.send(JSON.stringify(json_out));","                    });                   ","                } else {","                    res.send(\"Device id null.\");","                }","            }","        });","        ","\t}","});","","var server = app.listen(httpport, function() {","    console.log('HTTP listening on port :%d', server.address().port);","    console.log('Dir :%s', __dirname);","});"]}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":0},"end":{"row":338,"column":1}},"text":"、"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":1},"end":{"row":338,"column":2}},"text":"、"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":338,"column":1},"end":{"row":338,"column":2}},"text":"、"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":338,"column":0},"end":{"row":338,"column":1}},"text":"、"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":0},"end":{"row":338,"column":1}},"text":"/"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":1},"end":{"row":338,"column":2}},"text":"/"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":2},"end":{"row":338,"column":3}},"text":"d"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":3},"end":{"row":338,"column":4}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":338,"column":3},"end":{"row":338,"column":4}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":338,"column":2},"end":{"row":338,"column":3}},"text":"d"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":2},"end":{"row":339,"column":0}},"text":"\r\n"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":0},"end":{"row":339,"column":1}},"text":"/"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":1},"end":{"row":339,"column":2}},"text":"/"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":2},"end":{"row":339,"column":3}},"text":"t"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":3},"end":{"row":339,"column":4}},"text":"h"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":4},"end":{"row":339,"column":5}},"text":"i"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":5},"end":{"row":339,"column":6}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":6},"end":{"row":339,"column":7}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":7},"end":{"row":339,"column":8}},"text":"f"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":8},"end":{"row":339,"column":9}},"text":"u"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":9},"end":{"row":339,"column":10}},"text":"n"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":10},"end":{"row":339,"column":11}},"text":"c"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":11},"end":{"row":339,"column":12}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":339,"column":11},"end":{"row":339,"column":12}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":11},"end":{"row":339,"column":12}},"text":"t"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":12},"end":{"row":339,"column":13}},"text":"i"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":13},"end":{"row":339,"column":14}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":14},"end":{"row":339,"column":15}},"text":"n"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":15},"end":{"row":339,"column":16}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":16},"end":{"row":339,"column":17}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":17},"end":{"row":339,"column":18}},"text":"f"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":339,"column":17},"end":{"row":339,"column":18}},"text":"f"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":17},"end":{"row":339,"column":18}},"text":"c"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":18},"end":{"row":339,"column":19}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":19},"end":{"row":339,"column":20}},"text":"n"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":20},"end":{"row":339,"column":21}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":21},"end":{"row":339,"column":22}},"text":"d"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":22},"end":{"row":339,"column":23}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":23},"end":{"row":339,"column":24}},"text":"l"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":24},"end":{"row":339,"column":25}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":25},"end":{"row":339,"column":26}},"text":"t"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":26},"end":{"row":339,"column":27}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":27},"end":{"row":339,"column":28}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":28},"end":{"row":339,"column":29}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":339,"column":28},"end":{"row":339,"column":29}},"text":"a"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":28},"end":{"row":339,"column":29}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":29},"end":{"row":339,"column":30}},"text":"v"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":30},"end":{"row":339,"column":31}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":339,"column":30},"end":{"row":339,"column":31}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":339,"column":29},"end":{"row":339,"column":30}},"text":"v"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":339,"column":28},"end":{"row":339,"column":29}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":28},"end":{"row":339,"column":29}},"text":"u"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":29},"end":{"row":339,"column":30}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":30},"end":{"row":339,"column":31}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":31},"end":{"row":339,"column":32}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":32},"end":{"row":339,"column":33}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":33},"end":{"row":339,"column":34}},"text":"."}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":339,"column":34},"end":{"row":340,"column":0}},"text":"\r\n"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":340,"column":0},"end":{"row":341,"column":0}},"text":"\r\n"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":341,"column":0},"end":{"row":342,"column":0}},"text":"\r\n"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":2},"end":{"row":338,"column":3}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":338,"column":2},"end":{"row":338,"column":3}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":2},"end":{"row":338,"column":3}},"text":"R"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":3},"end":{"row":338,"column":4}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":4},"end":{"row":338,"column":5}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":5},"end":{"row":338,"column":6}},"text":"v"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":6},"end":{"row":338,"column":7}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":7},"end":{"row":338,"column":8}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":8},"end":{"row":338,"column":9}},"text":"d"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":9},"end":{"row":338,"column":10}},"text":" "}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":10},"end":{"row":338,"column":11}},"text":"f"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":11},"end":{"row":338,"column":12}},"text":"u"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":12},"end":{"row":338,"column":13}},"text":"n"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":13},"end":{"row":338,"column":14}},"text":"c"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":14},"end":{"row":338,"column":15}},"text":"t"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":15},"end":{"row":338,"column":16}},"text":"i"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":16},"end":{"row":338,"column":17}},"text":"o"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":17},"end":{"row":338,"column":18}},"text":"n"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":18},"end":{"row":338,"column":19}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":338,"column":19},"end":{"row":338,"column":20}},"text":"."}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":346,"column":18},"end":{"row":346,"column":19}},"text":";"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":346,"column":17},"end":{"row":346,"column":18}},"text":")"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":346,"column":16},"end":{"row":346,"column":17}},"text":"p"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":346,"column":15},"end":{"row":346,"column":16}},"text":"m"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":346,"column":14},"end":{"row":346,"column":15}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":346,"column":13},"end":{"row":346,"column":14}},"text":"t"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":346,"column":12},"end":{"row":346,"column":13}},"text":"("}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":346,"column":11},"end":{"row":346,"column":12}},"text":"d"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":346,"column":10},"end":{"row":346,"column":11}},"text":"n"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":346,"column":9},"end":{"row":346,"column":10}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":346,"column":8},"end":{"row":346,"column":9}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":346,"column":7},"end":{"row":346,"column":8}},"text":"."}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":346,"column":6},"end":{"row":346,"column":7}},"text":"s"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":346,"column":5},"end":{"row":346,"column":6}},"text":"e"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":346,"column":4},"end":{"row":346,"column":5}},"text":"r"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":346,"column":3},"end":{"row":346,"column":4}},"text":"/"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":346,"column":2},"end":{"row":346,"column":3}},"text":"/"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":346,"column":1},"end":{"row":346,"column":2}},"text":"\t"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":346,"column":0},"end":{"row":346,"column":1}},"text":"\t"}]}],[{"group":"doc","deltas":[{"action":"removeText","range":{"start":{"row":345,"column":61},"end":{"row":346,"column":0}},"text":"\r\n"}]}],[{"group":"doc","deltas":[{"action":"insertText","range":{"start":{"row":344,"column":28},"end":{"row":345,"column":0}},"text":"\r\n"},{"action":"insertText","range":{"start":{"row":345,"column":0},"end":{"row":345,"column":4}},"text":"    "}]}]]},"ace":{"folds":[],"scrolltop":4162.5,"scrollleft":0,"selection":{"start":{"row":313,"column":71},"end":{"row":313,"column":71},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":259,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1406191855365,"hash":"45e9ca80f8a84df9f9f3a128fbc5e785de14628e"}